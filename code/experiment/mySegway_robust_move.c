
#include  <wiringPiI2C.h>
#include  <stdio.h>
#include  <stdlib.h>
#include  <math.h>
#include  <sys/time.h>





// Complimentary Filter parameters
double K0 = (double) 0.98;
double K1 = (double) 0.02;

int fd;
int acclX, acclY, acclZ;
int gyroX, gyroY, gyroZ;
double accl_scaled_x, accl_scaled_y, accl_scaled_z;
double gyro_scaled_x, gyro_scaled_y, gyro_scaled_z;


double gyro_offset_x, gyro_offset_y;
double gyro_total_x, gyro_total_y;
double gyro_x_delta, gyro_y_delta;
double rotation_x, rotation_y;
double last_x, last_y;

struct timeval tv, tv2;
unsigned long long      timer, t;

double deltaT;
/*起點為(0，0)然後往右，半徑為1的1/4的圓*/
double o[1001] = {0, 1.23370029647685e-06, 4.93479814178688e-06, 1.11032844040126e-05, 1.97391438628847e-05, 3.08423552103365e-05, 4.44128910501718e-05, 6.04507178986191e-05, 7.89557961838883e-05, 9.99280802465030e-05, 0.000123367518339412, 0.000149274052628212, 0.000177647619191035, 0.000208488148018882, 0.000241795563015956, 0.000277569781999443, 0.000315810716700060, 0.000356518272761952, 0.000399692349743463, 0.000445332841116697, 0.000493439634268400, 0.000544012610499856, 0.000597051645027102, 0.000652556606981714, 0.000710527359410795, 0.000770963759277099, 0.000833865657459909, 0.000899232898755042, 0.000967065321875293, 0.00103736275945088, 0.00111012503802999, 0.00118535197807890, 0.00126304339398253, 0.00134319909404501, 0.00142581888049020, 0.00151090254946207, 0.00159844989102498, 0.00168846068916462, 0.00178093472178820, 0.00187587176072546, 0.00197327157172844, 0.00207313391447295, 0.00217545854255852, 0.00228024520350933, 0.00238749363877477, 0.00249720358372996, 0.00260937476767631, 0.00272400691384289, 0.00284109973938607, 0.00296065295539105, 0.00308266626687204, 0.00320713937277339, 0.00333407196597013, 0.00346346373326867, 0.00359531435540761, 0.00372962350705874, 0.00386639085682750, 0.00400561606725414, 0.00414729879481435, 0.00429143868991988, 0.00443803539692000, 0.00458708855410184, 0.00473859779369168, 0.00489256274185534, 0.00504898301869983, 0.00520785823827352, 0.00536918800856767, 0.00553297193151703, 0.00569920960300108, 0.00586790061284492, 0.00603904454482029, 0.00621264097664653, 0.00638868947999161, 0.00656718962047342, 0.00674814095766063, 0.00693154304507371, 0.00711739543018630, 0.00730569765442624, 0.00749644925317627, 0.00768964975577591, 0.00788529868552212, 0.00808339555967064, 0.00828393988943710, 0.00848693117999833, 0.00869236893049341, 0.00890025263402516, 0.00911058177766133, 0.00932335584243549, 0.00953857430334881, 0.00975623662937120, 0.00997634228344246, 0.0101988907224738, 0.0104238813973491, 0.0106513137529261, 0.0108811872280382, 0.0111135012554954, 0.0113482552620859, 0.0115854486685777, 0.0118250808897195, 0.0120671513342426, 0.0123116594048622, 0.0125586044982792, 0.0128079860051809, 0.0130598033102431, 0.0133140557921320, 0.0135707428235046, 0.0138298637710111, 0.0140914179952967, 0.0143554048510020, 0.0146218236867658, 0.0148906738452261, 0.0151619546630218, 0.0154356654707947, 0.0157118055931902, 0.0159903743488603, 0.0162713710504642, 0.0165547950046703, 0.0168406455121585, 0.0171289218676208, 0.0174196233597641, 0.0177127492713113, 0.0180082988790035, 0.0183062714536011, 0.0186066662598867, 0.0189094825566659, 0.0192147195967696, 0.0195223766270556, 0.0198324528884110, 0.0201449476157531, 0.0204598600380326, 0.0207771893782343, 0.0210969348533794, 0.0214190956745279, 0.0217436710467800, 0.0220706601692782, 0.0224000622352093, 0.0227318764318065, 0.0230661019403513, 0.0234027379361754, 0.0237417835886630, 0.0240832380612526, 0.0244271005114393, 0.0247733700907766, 0.0251220459448788, 0.0254731272134229, 0.0258266130301507, 0.0261825025228711, 0.0265407948134623, 0.0269014890178735, 0.0272645842461277, 0.0276300796023234, 0.0279979741846373, 0.0283682670853260, 0.0287409573907287, 0.0291160441812690, 0.0294935265314575, 0.0298734035098942, 0.0302556741792702, 0.0306403375963707, 0.0310273928120770, 0.0314168388713689, 0.0318086748133268, 0.0322028996711345, 0.0325995124720815, 0.0329985122375649, 0.0333998979830927, 0.0338036687182853, 0.0342098234468785, 0.0346183611667261, 0.0350292808698017, 0.0354425815422019, 0.0358582621641483, 0.0362763217099903, 0.0366967591482075, 0.0371195734414124, 0.0375447635463527, 0.0379723284139141, 0.0384022669891229, 0.0388345782111481, 0.0392692610133050, 0.0397063143230569, 0.0401457370620183, 0.0405875281459571, 0.0410316864847979, 0.0414782109826242, 0.0419271005376809, 0.0423783540423778, 0.0428319703832917, 0.0432879484411695, 0.0437462870909305, 0.0442069852016699, 0.0446700416366607, 0.0451354552533571, 0.0456032249033974, 0.0460733494326064, 0.0465458276809988, 0.0470206584827811, 0.0474978406663559, 0.0479773730543234, 0.0484592544634850, 0.0489434837048465, 0.0494300595836200, 0.0499189808992283, 0.0504102464453063, 0.0509038550097054, 0.0513998053744954, 0.0518980963159680, 0.0523987266046400, 0.0529016950052557, 0.0534070002767908, 0.0539146411724547, 0.0544246164396939, 0.0549369248201952, 0.0554515650498885, 0.0559685358589502, 0.0564878359718064, 0.0570094641071356, 0.0575334189778720, 0.0580596992912094, 0.0585883037486031, 0.0591192310457745, 0.0596524798727131, 0.0601880489136804, 0.0607259368472130, 0.0612661423461259, 0.0618086640775158, 0.0623535007027644, 0.0629006508775412, 0.0634501132518077, 0.0640018864698200, 0.0645559691701327, 0.0651123599856017, 0.0656710575433880, 0.0662320604649609, 0.0667953673661014, 0.0673609768569059, 0.0679288875417891, 0.0684990980194877, 0.0690716068830642, 0.0696464127199100, 0.0702235141117485, 0.0708029096346398, 0.0713845978589827, 0.0719685773495195, 0.0725548466653386, 0.0731434043598792, 0.0737342489809334, 0.0743273790706508, 0.0749227931655420, 0.0755204897964819, 0.0761204674887133, 0.0767227247618511, 0.0773272601298851, 0.0779340721011848, 0.0785431591785015, 0.0791545198589738, 0.0797681526341296, 0.0803840559898914, 0.0810022284065787, 0.0816226683589124, 0.0822453743160189, 0.0828703447414328, 0.0834975780931020, 0.0841270728233905, 0.0847588273790825, 0.0853928402013864, 0.0860291097259388, 0.0866676343828078, 0.0873084125964972, 0.0879514427859506, 0.0885967233645547, 0.0892442527401441, 0.0898940293150043, 0.0905460514858761, 0.0912003176439599, 0.0918568261749186, 0.0925155754588831, 0.0931765638704546, 0.0938397897787102, 0.0945052515472057, 0.0951729475339805, 0.0958428760915610, 0.0965150355669652, 0.0971894243017063, 0.0978660406317972, 0.0985448828877543, 0.0992259493946019, 0.0999092384718761, 0.100594748433629, 0.101282477588433, 0.101972424239384, 0.102664586684109, 0.103358963214764, 0.104055552118045, 0.104754351675188, 0.105455360161975, 0.106158575848736, 0.106863997000357, 0.107571621876282, 0.108281448730516, 0.108993475811632, 0.109707701362774, 0.110424123621662, 0.111142740820595, 0.111863551186455, 0.112586552940717, 0.113311744299444, 0.114039123473298, 0.114768688667545, 0.115500438082054, 0.116234369911307, 0.116970482344399, 0.117708773565047, 0.118449241751590, 0.119191885076996, 0.119936701708868, 0.120683689809444, 0.121432847535605, 0.122184173038878, 0.122937664465444, 0.123693319956136, 0.124451137646451, 0.125211115666547, 0.125973252141256, 0.126737545190080, 0.127503992927203, 0.128272593461491, 0.129043344896499, 0.129816245330474, 0.130591292856362, 0.131368485561809, 0.132147821529169, 0.132929298835510, 0.133712915552613, 0.134498669746981, 0.135286559479845, 0.136076582807165, 0.136868737779636, 0.137663022442696, 0.138459434836526, 0.139257972996056, 0.140058634950975, 0.140861418725728, 0.141666322339525, 0.142473343806348, 0.143282481134950, 0.144093732328867, 0.144907095386416, 0.145722568300705, 0.146540149059635, 0.147359835645908, 0.148181626037027, 0.149005518205308, 0.149831510117878, 0.150659599736684, 0.151489785018496, 0.152322063914917, 0.153156434372379, 0.153992894332158, 0.154831441730370, 0.155672074497985, 0.156514790560823, 0.157359587839568, 0.158206464249765, 0.159055417701831, 0.159906446101058, 0.160759547347618, 0.161614719336569, 0.162471959957858, 0.163331267096330, 0.164192638631730, 0.165056072438708, 0.165921566386829, 0.166789118340571, 0.167658726159337, 0.168530387697455, 0.169404100804187, 0.170279863323734, 0.171157673095238, 0.172037527952791, 0.172919425725438, 0.173803364237185, 0.174689341307000, 0.175577354748825, 0.176467402371573, 0.177359481979140, 0.178253591370410, 0.179149728339255, 0.180047890674548, 0.180948076160161, 0.181850282574977, 0.182754507692890, 0.183660749282816, 0.184569005108693, 0.185479272929491, 0.186391550499213, 0.187305835566906, 0.188222125876662, 0.189140419167626, 0.190060713174001, 0.190983005625053, 0.191907294245115, 0.192833576753600, 0.193761850864995, 0.194692114288878, 0.195624364729916, 0.196558599887872, 0.197494817457616, 0.198433015129123, 0.199373190587484, 0.200315341512909, 0.201259465580735, 0.202205560461429, 0.203153623820596, 0.204103653318984, 0.205055646612490, 0.206009601352165, 0.206965515184220, 0.207923385750033, 0.208883210686154, 0.209844987624310, 0.210808714191411, 0.211774388009560, 0.212742006696051, 0.213711567863381, 0.214683069119255, 0.215656508066590, 0.216631882303522, 0.217609189423412, 0.218588427014852, 0.219569592661670, 0.220552683942939, 0.221537698432977, 0.222524633701359, 0.223513487312921, 0.224504256827766, 0.225496939801266, 0.226491533784077, 0.227488036322136, 0.228486444956672, 0.229486757224211, 0.230488970656582, 0.231493082780923, 0.232499091119688, 0.233506993190650, 0.234516786506912, 0.235528468576908, 0.236542036904415, 0.237557488988552, 0.238574822323793, 0.239594034399969, 0.240615122702275, 0.241638084711278, 0.242662917902920, 0.243689619748528, 0.244718187714816, 0.245748619263896, 0.246780911853280, 0.247815062935889, 0.248851069960057, 0.249888930369541, 0.250928641603522, 0.251970201096618, 0.253013606278882, 0.254058854575818, 0.255105943408378, 0.256154870192975, 0.257205632341486, 0.258258227261261, 0.259312652355125, 0.260368905021390, 0.261426982653858, 0.262486882641826, 0.263548602370098, 0.264612139218984, 0.265677490564314, 0.266744653777440, 0.267813626225242, 0.268884405270136, 0.269956988270082, 0.271031372578588, 0.272107555544718, 0.273185534513097, 0.274265306823919, 0.275346869812953, 0.276430220811551, 0.277515357146650, 0.278602276140786, 0.279690975112093, 0.280781451374315, 0.281873702236811, 0.282967725004560, 0.284063516978169, 0.285161075453881, 0.286260397723579, 0.287361481074795, 0.288464322790715, 0.289568920150187, 0.290675270427726, 0.291783370893524, 0.292893218813452, 0.294004811449072, 0.295118146057639, 0.296233219892109, 0.297350030201151, 0.298468574229144, 0.299588849216194, 0.300710852398132, 0.301834581006527, 0.302960032268692, 0.304087203407686, 0.305216091642327, 0.306346694187195, 0.307479008252641, 0.308613031044794, 0.309748759765563, 0.310886191612652, 0.312025323779560, 0.313166153455592, 0.314308677825864, 0.315452894071311, 0.316598799368694, 0.317746390890604, 0.318895665805473, 0.320046621277581, 0.321199254467058, 0.322353562529898, 0.323509542617959, 0.324667191878976, 0.325826507456564, 0.326987486490227, 0.328150126115365, 0.329314423463280, 0.330480375661184, 0.331647979832207, 0.332817233095400, 0.333988132565748, 0.335160675354173, 0.336334858567541, 0.337510679308673, 0.338688134676348, 0.339867221765311, 0.341047937666283, 0.342230279465964, 0.343414244247044, 0.344599829088206, 0.345787031064139, 0.346975847245539, 0.348166274699121, 0.349358310487623, 0.350551951669816, 0.351747195300509, 0.352944038430556, 0.354142478106866, 0.355342511372409, 0.356544135266221, 0.357747346823416, 0.358952143075188, 0.360158521048822, 0.361366477767700, 0.362576010251310, 0.363787115515251, 0.364999790571239, 0.366214032427121, 0.367429838086875, 0.368647204550622, 0.369866128814631, 0.371086607871327, 0.372308638709299, 0.373532218313309, 0.374757343664295, 0.375984011739381, 0.377212219511887, 0.378441963951332, 0.379673242023444, 0.380906050690166, 0.382140386909666, 0.383376247636341, 0.384613629820829, 0.385852530410011, 0.387092946347023, 0.388334874571264, 0.389578312018398, 0.390823255620366, 0.392069702305395, 0.393317648998000, 0.394567092618999, 0.395818030085512, 0.397070458310975, 0.398324374205148, 0.399579774674116, 0.400836656620304, 0.402095016942481, 0.403354852535768, 0.404616160291645, 0.405878937097962, 0.407143179838941, 0.408408885395190, 0.409676050643706, 0.410944672457884, 0.412214747707527, 0.413486273258850, 0.414759245974490, 0.416033662713514, 0.417309520331424, 0.418586815680169, 0.419865545608151, 0.421145706960229, 0.422427296577732, 0.423710311298467, 0.424994747956722, 0.426280603383276, 0.427567874405409, 0.428856557846909, 0.430146650528076, 0.431438149265736, 0.432731050873244, 0.434025352160492, 0.435321049933923, 0.436618140996530, 0.437916622147869, 0.439216490184069, 0.440517741897833, 0.441820374078453, 0.443124383511812, 0.444429766980398, 0.445736521263306, 0.447044643136250, 0.448354129371570, 0.449664976738238, 0.450977182001868, 0.452290741924726, 0.453605653265731, 0.454921912780471, 0.456239517221208, 0.457558463336881, 0.458878747873124, 0.460200367572265, 0.461523319173340, 0.462847599412096, 0.464173205021003, 0.465500132729263, 0.466828379262811, 0.468157941344333, 0.469488815693266, 0.470820999025809, 0.472154488054934, 0.473489279490387, 0.474825370038704, 0.476162756403215, 0.477501435284051, 0.478841403378156, 0.480182657379291, 0.481525193978045, 0.482869009861843, 0.484214101714953, 0.485560466218494, 0.486908100050445, 0.488256999885655, 0.489607162395847, 0.490958584249629, 0.492311262112502, 0.493665192646867, 0.495020372512037, 0.496376798364239, 0.497734466856628, 0.499093374639290, 0.500453518359257, 0.501814894660509, 0.503177500183986, 0.504541331567592, 0.505906385446212, 0.507272658451708, 0.508640147212940, 0.510008848355763, 0.511378758503045, 0.512749874274668, 0.514122192287539, 0.515495709155602, 0.516870421489839, 0.518246325898285, 0.519623418986032, 0.521001697355239, 0.522381157605143, 0.523761796332061, 0.525143610129406, 0.526526595587688, 0.527910749294529, 0.529296067834667, 0.530682547789967, 0.532070185739427, 0.533458978259187, 0.534848921922542, 0.536240013299942, 0.537632248959008, 0.539025625464538, 0.540420139378512, 0.541815787260107, 0.543212565665700, 0.544610471148880, 0.546009500260453, 0.547409649548454, 0.548810915558155, 0.550213294832070, 0.551616783909968, 0.553021379328879, 0.554427077623104, 0.555833875324221, 0.557241768961098, 0.558650755059897, 0.560060830144085, 0.561471990734441, 0.562884233349067, 0.564297554503395, 0.565711950710196, 0.567127418479586, 0.568543954319041, 0.569961554733399, 0.571380216224872, 0.572799935293053, 0.574220708434927, 0.575642532144878, 0.577065402914697, 0.578489317233591, 0.579914271588194, 0.581340262462572, 0.582767286338235, 0.584195339694143, 0.585624419006716, 0.587054520749843, 0.588485641394891, 0.589917777410712, 0.591350925263651, 0.592785081417560, 0.594220242333800, 0.595656404471255, 0.597093564286337, 0.598531718232998, 0.599970862762735, 0.601410994324603, 0.602852109365220, 0.604294204328777, 0.605737275657049, 0.607181319789401, 0.608626333162798, 0.610072312211812, 0.611519253368634, 0.612967153063081, 0.614416007722603, 0.615865813772297, 0.617316567634910, 0.618768265730851, 0.620220904478199, 0.621674480292712, 0.623128989587837, 0.624584428774717, 0.626040794262200, 0.627498082456848, 0.628956289762949, 0.630415412582520, 0.631875447315322, 0.633336390358863, 0.634798238108412, 0.636260986957005, 0.637724633295455, 0.639189173512358, 0.640654603994109, 0.642120921124904, 0.643588121286749, 0.645056200859476, 0.646525156220743, 0.647994983746049, 0.649465679808741, 0.650937240780022, 0.652409663028963, 0.653882942922507, 0.655357076825483, 0.656832061100612, 0.658307892108517, 0.659784566207731, 0.661262079754709, 0.662740429103832, 0.664219610607419, 0.665699620615739, 0.667180455477013, 0.668662111537429, 0.670144585141147, 0.671627872630311, 0.673111970345058, 0.674596874623522, 0.676082581801851, 0.677569088214209, 0.679056390192790, 0.680544484067825, 0.682033366167589, 0.683523032818414, 0.685013480344695, 0.686504705068902, 0.687996703311585, 0.689489471391388, 0.690983005625053, 0.692477302327432, 0.693972357811499, 0.695468168388352, 0.696964730367226, 0.698462040055504, 0.699960093758724, 0.701458887780586, 0.702958418422965, 0.704458681985919, 0.705959674767696, 0.707461393064746, 0.708963833171728, 0.710466991381521, 0.711970863985231, 0.713475447272202, 0.714980737530024, 0.716486731044543, 0.717993424099871, 0.719500812978390, 0.721008893960771, 0.722517663325972, 0.724027117351254, 0.725537252312191, 0.727048064482675, 0.728559550134926, 0.730071705539504, 0.731584526965315, 0.733098010679624, 0.734612152948060, 0.736126950034627, 0.737642398201714, 0.739158493710103, 0.740675232818980, 0.742192611785940, 0.743710626867003, 0.745229274316618, 0.746748550387672, 0.748268451331503, 0.749788973397907, 0.751310112835145, 0.752831865889959, 0.754354228807574, 0.755877197831710, 0.757400769204592, 0.758924939166961, 0.760449703958078, 0.761975059815738, 0.763501002976275, 0.765027529674579, 0.766554636144095, 0.768082318616840, 0.769610573323409, 0.771139396492987, 0.772668784353354, 0.774198733130896, 0.775729239050619, 0.777260298336150, 0.778791907209753, 0.780324061892335, 0.781856758603457, 0.783389993561343, 0.784923762982887, 0.786458063083665, 0.787992890077946, 0.789528240178694, 0.791064109597588, 0.792600494545022, 0.794137391230119, 0.795674795860738, 0.797212704643488, 0.798751113783730, 0.800290019485593, 0.801829417951981, 0.803369305384580, 0.804909677983872, 0.806450531949140, 0.807991863478480, 0.809533668768810, 0.811075944015879, 0.812618685414276, 0.814161889157439, 0.815705551437667, 0.817249668446127, 0.818794236372863, 0.820339251406807, 0.821884709735790, 0.823430607546545, 0.824976941024724, 0.826523706354903, 0.828070899720590, 0.829618517304243, 0.831166555287266, 0.832715009850031, 0.834263877171880, 0.835813153431137, 0.837362834805117, 0.838912917470134, 0.840463397601514, 0.842014271373601, 0.843565534959769, 0.845117184532429, 0.846669216263039, 0.848221626322116, 0.849774410879243, 0.851327566103077, 0.852881088161363, 0.854434973220938, 0.855989217447748, 0.857543817006847, 0.859098768062417, 0.860654066777770, 0.862209709315362, 0.863765691836798, 0.865322010502848, 0.866878661473448, 0.868435640907717, 0.869992944963965, 0.871550569799697, 0.873108511571629, 0.874666766435696, 0.876225330547057, 0.877784200060111, 0.879343371128502, 0.880902839905130, 0.882462602542162, 0.884022655191039, 0.885582994002484, 0.887143615126518, 0.888704514712463, 0.890265688908955, 0.891827133863950, 0.893388845724740, 0.894950820637955, 0.896513054749577, 0.898075544204950, 0.899638285148785, 0.901201273725175, 0.902764506077601, 0.904327978348942, 0.905891686681486, 0.907455627216938, 0.909019796096430, 0.910584189460531, 0.912148803449257, 0.913713634202077, 0.915278677857927, 0.916843930555217, 0.918409388431842, 0.919975047625191, 0.921540904272155, 0.923106954509138, 0.924673194472067, 0.926239620296401, 0.927806228117139, 0.929373014068833, 0.930939974285594, 0.932507104901103, 0.934074402048622, 0.935641861861000, 0.937209480470687, 0.938777254009738, 0.940345178609829, 0.941913250402262, 0.943481465517976, 0.945049820087554, 0.946618310241239, 0.948186932108938, 0.949755681820230, 0.951324555504383, 0.952893549290358, 0.954462659306816, 0.956031881682135, 0.957601212544416, 0.959170648021490, 0.960740184240931, 0.962309817330065, 0.963879543415979, 0.965449358625528, 0.967019259085350, 0.968589240921872, 0.970159300261319, 0.971729433229727, 0.973299635952948, 0.974869904556662, 0.976440235166390, 0.978010623907495, 0.979581066905200, 0.981151560284592, 0.982722100170636, 0.984292682688179, 0.985863303961967, 0.987433960116647, 0.989004647276782, 0.990575361566856, 0.992146099111289, 0.993716856034441, 0.995287628460627, 0.996858412514120, 0.998429204319169, 1.00000000000000};
double p[1001] = {0, 0.00157079568083088, 0.00314158748587956, 0.00471237153937342, 0.00628314396555895, 0.00785390088871133, 0.00942463843314401, 0.0109953527232182, 0.0125660398833526, 0.0141366960380327, 0.0157073173118207, 0.0172778998293646, 0.0188484397154082, 0.0204189330948005, 0.0219893760925051, 0.0235597648336102, 0.0251300954433375, 0.0267003640470524, 0.0282705667702733, 0.0298406997386809, 0.0314107590781283, 0.0329807409146501, 0.0345506413744723, 0.0361204565840214, 0.0376901826699345, 0.0392598157590686, 0.0408293519785100, 0.0423987874555841, 0.0439681183178649, 0.0455373406931845, 0.0471064507096427, 0.0486754444956164, 0.0502443181797696, 0.0518130678910622, 0.0533816897587605, 0.0549501799124458, 0.0565185344820245, 0.0580867495977378, 0.0596548213901707, 0.0612227459902619, 0.0627905195293134, 0.0643581381389997, 0.0659255979513779, 0.0674928950988965, 0.0690600257144058, 0.0706269859311667, 0.0721937718828606, 0.0737603797035990, 0.0753268055279327, 0.0768930454908618, 0.0784590957278449, 0.0800249523748087, 0.0815906115681575, 0.0831560694447830, 0.0847213221420735, 0.0862863657979234, 0.0878511965507432, 0.0894158105394685, 0.0909802039035699, 0.0925443727830622, 0.0941083133185143, 0.0956720216510583, 0.0972354939223993, 0.0987987262748250, 0.100361714851215, 0.101924455795050, 0.103486945250423, 0.105049179362045, 0.106611154275260, 0.108172866136050, 0.109734311091045, 0.111295485287537, 0.112856384873482, 0.114417005997516, 0.115977344808961, 0.117537397457838, 0.119097160094870, 0.120656628871498, 0.122215799939889, 0.123774669452943, 0.125333233564304, 0.126891488428370, 0.128449430200303, 0.130007055036035, 0.131564359092283, 0.133121338526552, 0.134677989497153, 0.136234308163202, 0.137790290684638, 0.139345933222230, 0.140901231937583, 0.142456182993153, 0.144010782552252, 0.145565026779061, 0.147118911838637, 0.148672433896923, 0.150225589120757, 0.151778373677883, 0.153330783736961, 0.154882815467571, 0.156434465040231, 0.157985728626399, 0.159536602398486, 0.161087082529866, 0.162637165194884, 0.164186846568863, 0.165736122828120, 0.167284990149969, 0.168833444712734, 0.170381482695757, 0.171929100279410, 0.173476293645098, 0.175023058975276, 0.176569392453455, 0.178115290264210, 0.179660748593193, 0.181205763627137, 0.182750331553874, 0.184294448562333, 0.185838110842561, 0.187381314585725, 0.188924055984121, 0.190466331231190, 0.192008136521520, 0.193549468050860, 0.195090322016128, 0.196630694615420, 0.198170582048019, 0.199709980514407, 0.201248886216270, 0.202787295356513, 0.204325204139262, 0.205862608769881, 0.207399505454978, 0.208935890402412, 0.210471759821306, 0.212007109922055, 0.213541936916335, 0.215076237017113, 0.216610006438657, 0.218143241396543, 0.219675938107665, 0.221208092790247, 0.222739701663850, 0.224270760949381, 0.225801266869104, 0.227331215646646, 0.228860603507013, 0.230389426676591, 0.231917681383160, 0.233445363855905, 0.234972470325421, 0.236498997023725, 0.238024940184263, 0.239550296041922, 0.241075060833039, 0.242599230795407, 0.244122802168290, 0.245645771192426, 0.247168134110041, 0.248689887164855, 0.250211026602094, 0.251731548668497, 0.253251449612328, 0.254770725683382, 0.256289373132997, 0.257807388214060, 0.259324767181021, 0.260841506289897, 0.262357601798286, 0.263873049965373, 0.265387847051940, 0.266901989320376, 0.268415473034685, 0.269928294460496, 0.271440449865074, 0.272951935517325, 0.274462747687809, 0.275972882648746, 0.277482336674029, 0.278991106039229, 0.280499187021610, 0.282006575900129, 0.283513268955457, 0.285019262469976, 0.286524552727798, 0.288029136014769, 0.289533008618479, 0.291036166828272, 0.292538606935254, 0.294040325232304, 0.295541318014081, 0.297041581577035, 0.298541112219414, 0.300039906241276, 0.301537959944496, 0.303035269632774, 0.304531831611648, 0.306027642188501, 0.307522697672567, 0.309016994374947, 0.310510528608612, 0.312003296688415, 0.313495294931098, 0.314986519655305, 0.316476967181586, 0.317966633832411, 0.319455515932175, 0.320943609807210, 0.322430911785791, 0.323917418198149, 0.325403125376478, 0.326888029654942, 0.328372127369689, 0.329855414858853, 0.331337888462571, 0.332819544522987, 0.334300379384261, 0.335780389392581, 0.337259570896169, 0.338737920245291, 0.340215433792269, 0.341692107891483, 0.343167938899388, 0.344642923174517, 0.346117057077493, 0.347590336971037, 0.349062759219978, 0.350534320191259, 0.352005016253951, 0.353474843779257, 0.354943799140524, 0.356411878713251, 0.357879078875096, 0.359345396005891, 0.360810826487642, 0.362275366704546, 0.363739013042995, 0.365201761891588, 0.366663609641137, 0.368124552684678, 0.369584587417480, 0.371043710237051, 0.372501917543152, 0.373959205737800, 0.375415571225283, 0.376871010412163, 0.378325519707288, 0.379779095521801, 0.381231734269149, 0.382683432365090, 0.384134186227703, 0.385583992277397, 0.387032846936919, 0.388480746631366, 0.389927687788188, 0.391373666837202, 0.392818680210599, 0.394262724342951, 0.395705795671223, 0.397147890634781, 0.398589005675397, 0.400029137237265, 0.401468281767002, 0.402906435713663, 0.404343595528745, 0.405779757666200, 0.407214918582440, 0.408649074736349, 0.410082222589288, 0.411514358605109, 0.412945479250157, 0.414375580993284, 0.415804660305857, 0.417232713661765, 0.418659737537428, 0.420085728411806, 0.421510682766409, 0.422934597085303, 0.424357467855122, 0.425779291565073, 0.427200064706947, 0.428619783775128, 0.430038445266601, 0.431456045680959, 0.432872581520414, 0.434288049289805, 0.435702445496605, 0.437115766650933, 0.438528009265559, 0.439939169855915, 0.441349244940103, 0.442758231038902, 0.444166124675779, 0.445572922376896, 0.446978620671121, 0.448383216090032, 0.449786705167930, 0.451189084441845, 0.452590350451546, 0.453990499739547, 0.455389528851120, 0.456787434334299, 0.458184212739893, 0.459579860621488, 0.460974374535462, 0.462367751040992, 0.463759986700058, 0.465151078077458, 0.466541021740813, 0.467929814260573, 0.469317452210033, 0.470703932165333, 0.472089250705471, 0.473473404412312, 0.474856389870595, 0.476238203667939, 0.477618842394858, 0.478998302644761, 0.480376581013969, 0.481753674101715, 0.483129578510161, 0.484504290844398, 0.485877807712461, 0.487250125725332, 0.488621241496955, 0.489991151644237, 0.491359852787060, 0.492727341548292, 0.494093614553788, 0.495458668432408, 0.496822499816014, 0.498185105339491, 0.499546481640743, 0.500906625360710, 0.502265533143373, 0.503623201635761, 0.504979627487963, 0.506334807353133, 0.507688737887498, 0.509041415750371, 0.510392837604153, 0.511743000114345, 0.513091899949555, 0.514439533781506, 0.515785898285048, 0.517130990138157, 0.518474806021955, 0.519817342620709, 0.521158596621844, 0.522498564715949, 0.523837243596785, 0.525174629961296, 0.526510720509613, 0.527845511945067, 0.529179000974191, 0.530511184306734, 0.531842058655667, 0.533171620737189, 0.534499867270737, 0.535826794978997, 0.537152400587904, 0.538476680826660, 0.539799632427735, 0.541121252126876, 0.542441536663119, 0.543760482778792, 0.545078087219529, 0.546394346734269, 0.547709258075275, 0.549022817998132, 0.550335023261762, 0.551645870628430, 0.552955356863750, 0.554263478736694, 0.555570233019602, 0.556875616488188, 0.558179625921548, 0.559482258102167, 0.560783509815931, 0.562083377852131, 0.563381859003470, 0.564678950066077, 0.565974647839508, 0.567268949126757, 0.568561850734264, 0.569853349471924, 0.571143442153091, 0.572432125594591, 0.573719396616724, 0.575005252043279, 0.576289688701533, 0.577572703422268, 0.578854293039771, 0.580134454391849, 0.581413184319831, 0.582690479668576, 0.583966337286487, 0.585240754025510, 0.586513726741150, 0.587785252292473, 0.589055327542116, 0.590323949356295, 0.591591114604810, 0.592856820161059, 0.594121062902039, 0.595383839708355, 0.596645147464232, 0.597904983057519, 0.599163343379696, 0.600420225325884, 0.601675625794852, 0.602929541689025, 0.604181969914488, 0.605432907381001, 0.606682351002000, 0.607930297694605, 0.609176744379634, 0.610421687981603, 0.611665125428736, 0.612907053652977, 0.614147469589989, 0.615386370179171, 0.616623752363659, 0.617859613090334, 0.619093949309834, 0.620326757976556, 0.621558036048668, 0.622787780488113, 0.624015988260619, 0.625242656335705, 0.626467781686691, 0.627691361290701, 0.628913392128673, 0.630133871185369, 0.631352795449378, 0.632570161913124, 0.633785967572879, 0.635000209428761, 0.636212884484749, 0.637423989748690, 0.638633522232300, 0.639841478951178, 0.641047856924813, 0.642252653176584, 0.643455864733779, 0.644657488627591, 0.645857521893134, 0.647055961569444, 0.648252804699491, 0.649448048330184, 0.650641689512376, 0.651833725300879, 0.653024152754461, 0.654212968935861, 0.655400170911794, 0.656585755752957, 0.657769720534036, 0.658952062333717, 0.660132778234689, 0.661311865323652, 0.662489320691327, 0.663665141432459, 0.664839324645827, 0.666011867434252, 0.667182766904600, 0.668352020167793, 0.669519624338816, 0.670685576536720, 0.671849873884635, 0.673012513509773, 0.674173492543437, 0.675332808121024, 0.676490457382041, 0.677646437470102, 0.678800745532942, 0.679953378722419, 0.681104334194527, 0.682253609109397, 0.683401200631306, 0.684547105928689, 0.685691322174136, 0.686833846544408, 0.687974676220440, 0.689113808387349, 0.690251240234437, 0.691386968955206, 0.692520991747359, 0.693653305812805, 0.694783908357673, 0.695912796592314, 0.697039967731308, 0.698165418993473, 0.699289147601868, 0.700411150783806, 0.701531425770856, 0.702649969798849, 0.703766780107891, 0.704881853942362, 0.705995188550928, 0.707106781186548, 0.708216629106476, 0.709324729572274, 0.710431079849814, 0.711535677209285, 0.712638518925205, 0.713739602276421, 0.714838924546119, 0.715936483021831, 0.717032274995440, 0.718126297763189, 0.719218548625685, 0.720309024887907, 0.721397723859214, 0.722484642853350, 0.723569779188449, 0.724653130187047, 0.725734693176081, 0.726814465486903, 0.727892444455282, 0.728968627421412, 0.730043011729918, 0.731115594729864, 0.732186373774759, 0.733255346222560, 0.734322509435686, 0.735387860781016, 0.736451397629903, 0.737513117358174, 0.738573017346142, 0.739631094978610, 0.740687347644875, 0.741741772738739, 0.742794367658514, 0.743845129807025, 0.744894056591622, 0.745941145424182, 0.746986393721118, 0.748029798903382, 0.749071358396478, 0.750111069630460, 0.751148930039943, 0.752184937064111, 0.753219088146720, 0.754251380736104, 0.755281812285184, 0.756310380251472, 0.757337082097080, 0.758361915288722, 0.759384877297725, 0.760405965600031, 0.761425177676207, 0.762442511011448, 0.763457963095585, 0.764471531423092, 0.765483213493088, 0.766493006809350, 0.767500908880312, 0.768506917219077, 0.769511029343418, 0.770513242775789, 0.771513555043328, 0.772511963677865, 0.773508466215923, 0.774503060198734, 0.775495743172235, 0.776486512687079, 0.777475366298641, 0.778462301567023, 0.779447316057062, 0.780430407338330, 0.781411572985148, 0.782390810576588, 0.783368117696478, 0.784343491933410, 0.785316930880745, 0.786288432136619, 0.787257993303949, 0.788225611990440, 0.789191285808589, 0.790155012375690, 0.791116789313846, 0.792076614249967, 0.793034484815780, 0.793990398647835, 0.794944353387510, 0.795896346681016, 0.796846376179404, 0.797794439538571, 0.798740534419265, 0.799684658487091, 0.800626809412516, 0.801566984870877, 0.802505182542384, 0.803441400112128, 0.804375635270085, 0.805307885711122, 0.806238149135005, 0.807166423246400, 0.808092705754885, 0.809016994374948, 0.809939286825999, 0.810859580832373, 0.811777874123338, 0.812694164433094, 0.813608449500787, 0.814520727070509, 0.815430994891307, 0.816339250717184, 0.817245492307110, 0.818149717425024, 0.819051923839839, 0.819952109325452, 0.820850271660745, 0.821746408629590, 0.822640518020860, 0.823532597628428, 0.824422645251175, 0.825310658693000, 0.826196635762815, 0.827080574274562, 0.827962472047209, 0.828842326904762, 0.829720136676266, 0.830595899195813, 0.831469612302545, 0.832341273840663, 0.833210881659429, 0.834078433613171, 0.834943927561292, 0.835807361368270, 0.836668732903670, 0.837528040042142, 0.838385280663431, 0.839240452652382, 0.840093553898942, 0.840944582298169, 0.841793535750235, 0.842640412160432, 0.843485209439177, 0.844327925502015, 0.845168558269629, 0.846007105667842, 0.846843565627621, 0.847677936085083, 0.848510214981504, 0.849340400263317, 0.850168489882122, 0.850994481794692, 0.851818373962973, 0.852640164354092, 0.853459850940365, 0.854277431699295, 0.855092904613584, 0.855906267671133, 0.856717518865050, 0.857526656193652, 0.858333677660475, 0.859138581274273, 0.859941365049025, 0.860742027003944, 0.861540565163474, 0.862336977557304, 0.863131262220364, 0.863923417192835, 0.864713440520155, 0.865501330253019, 0.866287084447387, 0.867070701164490, 0.867852178470831, 0.868631514438191, 0.869408707143638, 0.870183754669526, 0.870956655103501, 0.871727406538509, 0.872496007072797, 0.873262454809920, 0.874026747858745, 0.874788884333453, 0.875548862353549, 0.876306680043864, 0.877062335534556, 0.877815826961122, 0.878567152464395, 0.879316310190556, 0.880063298291132, 0.880808114923004, 0.881550758248410, 0.882291226434953, 0.883029517655601, 0.883765630088694, 0.884499561917946, 0.885231311332455, 0.885960876526702, 0.886688255700557, 0.887413447059283, 0.888136448813545, 0.888857259179405, 0.889575876378338, 0.890292298637226, 0.891006524188368, 0.891718551269484, 0.892428378123718, 0.893136002999643, 0.893841424151264, 0.894544639838025, 0.895245648324812, 0.895944447881955, 0.896641036785236, 0.897335413315891, 0.898027575760616, 0.898717522411567, 0.899405251566371, 0.900090761528124, 0.900774050605398, 0.901455117112246, 0.902133959368203, 0.902810575698294, 0.903484964433035, 0.904157123908439, 0.904827052466020, 0.905494748452794, 0.906160210221290, 0.906823436129545, 0.907484424541117, 0.908143173825081, 0.908799682356040, 0.909453948514124, 0.910105970684996, 0.910755747259856, 0.911403276635445, 0.912048557214049, 0.912691587403503, 0.913332365617192, 0.913970890274061, 0.914607159798614, 0.915241172620918, 0.915872927176610, 0.916502421906898, 0.917129655258567, 0.917754625683981, 0.918377331641088, 0.918997771593421, 0.919615944010109, 0.920231847365870, 0.920845480141026, 0.921456840821498, 0.922065927898815, 0.922672739870115, 0.923277275238149, 0.923879532511287, 0.924479510203518, 0.925077206834458, 0.925672620929349, 0.926265751019067, 0.926856595640121, 0.927445153334661, 0.928031422650481, 0.928615402141017, 0.929197090365360, 0.929776485888252, 0.930353587280090, 0.930928393116936, 0.931500901980512, 0.932071112458211, 0.932639023143094, 0.933204632633899, 0.933767939535039, 0.934328942456612, 0.934887640014398, 0.935444030829867, 0.935998113530180, 0.936549886748192, 0.937099349122459, 0.937646499297236, 0.938191335922484, 0.938733857653874, 0.939274063152787, 0.939811951086320, 0.940347520127287, 0.940880768954226, 0.941411696251397, 0.941940300708791, 0.942466581022128, 0.942990535892864, 0.943512164028194, 0.944031464141050, 0.944548434950111, 0.945063075179805, 0.945575383560306, 0.946085358827545, 0.946592999723209, 0.947098304994744, 0.947601273395360, 0.948101903684032, 0.948600194625505, 0.949096144990295, 0.949589753554694, 0.950081019100772, 0.950569940416380, 0.951056516295154, 0.951540745536515, 0.952022626945677, 0.952502159333644, 0.952979341517219, 0.953454172319001, 0.953926650567394, 0.954396775096603, 0.954864544746643, 0.955329958363339, 0.955793014798330, 0.956253712909069, 0.956712051558831, 0.957168029616708, 0.957621645957622, 0.958072899462319, 0.958521789017376, 0.958968313515202, 0.959412471854043, 0.959854262937982, 0.960293685676943, 0.960730738986695, 0.961165421788852, 0.961597733010877, 0.962027671586086, 0.962455236453647, 0.962880426558588, 0.963303240851792, 0.963723678290010, 0.964141737835852, 0.964557418457798, 0.964970719130198, 0.965381638833274, 0.965790176553122, 0.966196331281715, 0.966600102016907, 0.967001487762435, 0.967400487527919, 0.967797100328866, 0.968191325186673, 0.968583161128631, 0.968972607187923, 0.969359662403629, 0.969744325820730, 0.970126596490106, 0.970506473468543, 0.970883955818731, 0.971259042609271, 0.971631732914674, 0.972002025815363, 0.972369920397677, 0.972735415753872, 0.973098510982127, 0.973459205186538, 0.973817497477129, 0.974173386969849, 0.974526872786577, 0.974877954055121, 0.975226629909223, 0.975572899488561, 0.975916761938747, 0.976258216411337, 0.976597262063825, 0.976933898059649, 0.977268123568194, 0.977599937764791, 0.977929339830722, 0.978256328953220, 0.978580904325472, 0.978903065146621, 0.979222810621766, 0.979540139961967, 0.979855052384247, 0.980167547111589, 0.980477623372944, 0.980785280403230, 0.981090517443334, 0.981393333740113, 0.981693728546399, 0.981991701120997, 0.982287250728689, 0.982580376640236, 0.982871078132379, 0.983159354487842, 0.983445204995330, 0.983728628949536, 0.984009625651140, 0.984288194406810, 0.984564334529205, 0.984838045336978, 0.985109326154774, 0.985378176313234, 0.985644595148998, 0.985908582004703, 0.986170136228989, 0.986429257176496, 0.986685944207868, 0.986940196689757, 0.987192013994819, 0.987441395501721, 0.987688340595138, 0.987932848665757, 0.988174919110281, 0.988414551331422, 0.988651744737914, 0.988886498744505, 0.989118812771962, 0.989348686247074, 0.989576118602651, 0.989801109277526, 0.990023657716558, 0.990243763370629, 0.990461425696651, 0.990676644157565, 0.990889418222339, 0.991099747365975, 0.991307631069507, 0.991513068820002, 0.991716060110563, 0.991916604440329, 0.992114701314478, 0.992310350244224, 0.992503550746824, 0.992694302345574, 0.992882604569814, 0.993068456954926, 0.993251859042339, 0.993432810379527, 0.993611310520008, 0.993787359023354, 0.993960955455180, 0.994132099387155, 0.994300790396999, 0.994467028068483, 0.994630811991432, 0.994792141761727, 0.994951016981300, 0.995107437258145, 0.995261402206308, 0.995412911445898, 0.995561964603080, 0.995708561310080, 0.995852701205186, 0.995994383932746, 0.996133609143173, 0.996270376492941, 0.996404685644592, 0.996536536266731, 0.996665928034030, 0.996792860627227, 0.996917333733128, 0.997039347044609, 0.997158900260614, 0.997275993086157, 0.997390625232324, 0.997502796416270, 0.997612506361225, 0.997719754796491, 0.997824541457442, 0.997926866085527, 0.998026728428272, 0.998124128239275, 0.998219065278212, 0.998311539310835, 0.998401550108975, 0.998489097450538, 0.998574181119510, 0.998656800905955, 0.998736956606018, 0.998814648021921, 0.998889874961970, 0.998962637240549, 0.999032934678125, 0.999100767101245, 0.999166134342540, 0.999229036240723, 0.999289472640589, 0.999347443393018, 0.999402948354973, 0.999455987389500, 0.999506560365732, 0.999554667158883, 0.999600307650257, 0.999643481727238, 0.999684189283300, 0.999722430218001, 0.999758204436984, 0.999791511851981, 0.999822352380809, 0.999850725947372, 0.999876632481661, 0.999900071919754, 0.999921044203816, 0.999939549282101, 0.999955587108950, 0.999969157644790, 0.999980260856137, 0.999988896715596, 0.999995065201858, 0.999998766299704, 1};


int read_word_2c(int addr)
{
  int val;
  val = wiringPiI2CReadReg8(fd, addr);
  val = val << 8;
  val += wiringPiI2CReadReg8(fd, addr+1);
  if (val >= 0x8000)
    val = -(65536 - val);

  return val;
}

double dist(double a, double b)
{
  return sqrt((a*a) + (b*b));
}

double get_y_rotation(double x, double y, double z)
{
  double radians;
  radians = atan2(x, dist(y, z));
  return -(radians * (180.0 / M_PI));
}

double get_x_rotation(double x, double y, double z)
{
  double radians;
  radians = atan2(y, dist(x, z));
  return (radians * (180.0 / M_PI));
}

void read_all()
{
    acclX = read_word_2c(0x3B);
    acclY = read_word_2c(0x3D);
    acclZ = read_word_2c(0x3F);

    accl_scaled_x = acclX / 16384.0;
    accl_scaled_y = acclY / 16384.0;
    accl_scaled_z = acclZ / 16384.0;

    gyroX = read_word_2c(0x43);
    gyroY = read_word_2c(0x45);
    gyroZ = read_word_2c(0x47);

    gyro_scaled_x = gyroX / 131.0;
    gyro_scaled_y = gyroY / 131.0;
    gyro_scaled_z = gyroZ / 131.0;





}

unsigned long long  getTimestamp()
{
  gettimeofday(&tv, NULL);
  return (unsigned long long) tv.tv_sec * 1000000 + tv.tv_usec;
}


double constrain(double v, double min_v, double max_v)
{
  if (v <= min_v)
    return (double)min_v;
  else if (v >= max_v)
    return (double)max_v;
  else
    return (double)v;
}

double GUARD_GAIN = 100.0;
double error_theta, last_error, integrated_error;
double pTerm, iTerm, dTerm;
double angle;
double angle_offset = 2.0;  //1.5

double speed_l,speed_r;

//Brain parameter set===============


//w part=======================
double mean[10] ={-1.6,-1,-0.6,-0.2,0,0.2,0.6,1,1.5,2};
double var[10] = {5,5,5,5,5,5,5,5,5,5};
double s[10] = {0,0,0,0,0,0,0,0,0};
double mean2[10] = { -1.6,-1,-0.6,-0.2,0,0.2,0.6,1,1.5,2 };
double var2[10] = { 5,5,5,5,5,5,5,5,5,5 };
double s2[10] = { 0,0,0,0,0,0,0,0,0 };
double recptive[10] = { 0,0,0,0,0,0,0,0,0 };


double weight_a[10] = { 0,0,0,0,0,0,0,0,0 };
double weight_p[10] = { 0,0,0,0,0,0,0,0,0 };

double delta_weight_a[10];
double delta_weight_p[10];
double delta_mean[10];
double delta_var[10];
double delta_mean2[10];
double delta_var2[10];
double identicalmatrix[10]= { 1,1,1,1,1,1,1,1,1,1 };
double identicalmatrix2[10] = { 1,1,1,1,1,1,1,1,1,1 };
double a, b, uc;
int value = 10;
double error_w, d_error_w, last_error_w=0;
double delta_w;
double d_w = 0, p_w = 0;
double receptive[10] = { 0,0,0,0,0,0,0,0,0,0 };

//v part=======================
double vmean[10] = { -1.6,-1,-0.6,-0.2,0,0.2,0.6,1,1.5,2 };
double vvar[10] = { 5,5,5,5,5,5,5,5,5,5 };
double vs[10] = { 0,0,0,0,0,0,0,0,0 };
double vmean2[10] = { -1.6,-1,-0.6,-0.2,0,0.2,0.6,1,1.5,2 };
double vvar2[10] = { 5,5,5,5,5,5,5,5,5,5 };
double vs2[10] = { 0,0,0,0,0,0,0,0,0 };
double vrecptive[10] = { 0,0,0,0,0,0,0,0,0 };


double vweight_a[10] = { 0,0,0,0,0,0,0,0,0 };
double vweight_p[10] = { 0,0,0,0,0,0,0,0,0 };

double vdelta_weight_a[10];
double vdelta_weight_p[10];
double vdelta_mean[10];
double vdelta_var[10];
double vdelta_mean2[10];
double vdelta_var2[10];
double videnticalmatrix[10] = { 1,1,1,1,1,1,1,1,1,1 };
double videnticalmatrix2[10] = { 1,1,1,1,1,1,1,1,1,1 };
double vreceptive[10] = { 0,0,0,0,0,0,0,0,0,0 };


double error_v, d_error_v, last_error_v = 0;
double delta_v,vuc;
double vdelta=0,wdelta=0;
double error_theta, d_error_theta;

//v part=======================

double sliding,sliding2;
int i;
double tu_v,tu_w;


int lamda1 = 1;
int lamda2 = 1;
int lamda3 = 20;
int lamda4 = 5;

double pi = 3.14159265359;
double wd, vd, wr = 3.14159265359 / 20, vr;
//Brain parameter set===============
double delta = 3.14159265359 / 2;
double xv = 0,v = 0,w = 0;
double d_x = 0, d_y = 0, d_delta = 0;
double x = 0, y = 0;
double xr = 0, yr = 0;
double deltar=0;

double error_xv;

double p_vd = 0,p_wd = 0;
double p_xr = 0, p_yr = 0;
double error_delta;
double error_x = 0, error_y = 0;
double xvd;
double T = 0;
int k = 0;

int sign(double j) {
	int a;
	if (j >= 0) {
		a=1; //true is positve
	}
	else {
		a=-1; //False is negative
	}
	return a;
}


void posture_controller() {


	/*
	xr = -1* cos(wr*t)+1;
	yr = 1 * sin(wr*t);
	*/

	/*
	xr = 5 * cos(3 * wr*t)*cos(wr*t);
	yr = 5 * cos(3 * wr*t)*sin(wr*t);
	*/

	/*
	if (T < 5) {
		xr = 0;
		yr = 0;
		wr = 0;
	}
	else {
		xr = 0;
		yr = T;
		wr = 3.14159265359 / 45;
	}
	*/

	if (pow((pow((xr - x), 2) + pow((yr - y), 2)),0.5) <= 0.5) {
		xr = o[k];
		yr = p[k];	
		if (k <= 1000) {
			k = k + 1;
		}
	}



	deltar = fmod((deltar + (wd)*deltaT ), (2 * pi));


	vr = 0.2;
	//= == == == == == == == == == == == == == == == ==

	//= == == == == == == == == == == == == == == == ==



	//= == == == == == == == == == == == == == == == ==

	//obtain error_x, error_y, error_delta
    error_x = (xr - x)*cos(delta) + (yr - y)*sin(delta);
	error_y = (xr - x)*-sin(delta) + (yr - y)*cos(delta);
	error_delta = deltar - delta;

	//= == == == == == == == == == == == == == == == ==


	wd = wr + 2 * lamda3*vr*error_y*cos(error_delta / 2) + lamda4*sin(error_delta / 2);
	
	if (abs(wd) < pi/4) {
		wd = wd;
	}
	else if (wd > pi/4) {
		wd = pi / 4;
	}
	else {
		wd = -pi / 4;
	}
	
	vd = vr*cos(error_delta) + lamda1*tanh(w)*w*error_x - lamda1*tanh(w)*(vr*sin(error_delta) + lamda2*error_y) + lamda2*error_x - lamda1*(1 - pow(tanh(w) , 2))*d_w*error_y;
	
	if (abs(vd) < 40) {
		vd = vd;
	}
	else if(vd > 40) {
		vd = 40;
	}
	else {
		vd = -40;
	}

	xvd = pow((pow(error_x ,2) + pow(error_y, 2)), 0.5);

	error_w = -(wd - w);
	error_v = -(vd - v);
	error_xv = -(xvd - xv);
}






void pidw()
{



	d_error_w = (error_w - last_error_w);
	last_error_w = error_w;

	if (error_w > 5) {
		tu_w = 5 * 3;
	}
	if (error_w < -5) {
		tu_w = -5 * 3;
	}
	if (abs(error_w) <= 5) {
		tu_w = error_w * 3;
	}

	wdelta = error_w + d_error_w;
	//direction()
	//cmac////////////////////////////////////////////////////////////////


	//adative laws == == == == == == == == == == == =

	for (i = 1; i <= value; i++) {
		delta_weight_a[i] = -0.1*wdelta*receptive[i];
		//delta_weight_p(i, :) = 0.1*delta*receptive[i];

		delta_mean[i] = -0.01*wdelta*(weight_a[i])*receptive[i] * (2 * (identicalmatrix[i] - mean[i]) / pow(var[i],2));
		delta_var[i] = -0.01*wdelta*(weight_a[i])*receptive[i] * (2 * pow((identicalmatrix[i] - mean[i]), 2) / pow(var[i], 3));

		delta_mean2[i] = -0.01*wdelta*(weight_a[i])*receptive[i] * (2 * (identicalmatrix2[i] - mean2[i]) / pow(var2[i], 2));
		delta_var2[i] = -0.01*wdelta*(weight_a[i])*receptive[i] * (2 * pow((identicalmatrix2[i] - mean2[i]) ,2) / pow(var2[i], 3));
		//update weight mean variance == == == == == == == == == ==


		weight_a[i] = weight_a[i] + delta_weight_a[i];
		//weight_p[i] = weight_p[i] + delta_weight_p[i];

		mean[i] = mean[i] + delta_mean[i];
		var[i] = var[i] + delta_var[i];

		mean2[i] = mean2[i] + delta_mean2[i];
		var2[i] = var2[i] + delta_var2[i];
	}

	//= == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == ==
		//controller


	double identicalmatrix[10] = { 1,1,1,1,1,1,1,1,1,1 };
	double identicalmatrix2[10] = { 1,1,1,1,1,1,1,1,1,1 };

	for (i = 1; i <= value; i++) {
		identicalmatrix[i] = identicalmatrix[i] * error_w;
		identicalmatrix2[i] = identicalmatrix2[i] * d_error_w;
	}

    //%receptive layer == == == == == =
	for (i = 1; i <= value; i++) {
		s[i] = exp(-pow(error_w - mean[i], 2) / pow(var[i], 2));
		s2[i] = exp(-pow(d_error_w - mean2[i], 2) / pow(var2[i], 2));
		receptive[i] = s[i]*s2[i];
		uc = uc + receptive[i] * weight_a[i];
	}

	//////////////////////////////////////////////////////////////////////



	tu_w = tu_w*7-0*uc;

}




void pidv()
{


	error_theta = last_y - angle_offset;

	//d_error = (error_theta - last_error_theat) / deltaT;
	//last_error = error;



	if (error_theta > 3) {
		tu_v = error_theta * 10*2;

	}
	if (error_theta < -3) {
		tu_v = error_theta * 10*2;

	}
	if (abs(error_theta) <= 3) {
		tu_v = error_theta * 10*2;

	}
	
	if (vd < 0) {
		if (angle_offset > -3/*-1*/) {
			angle_offset = angle_offset - 0.01*abs(vd);
		}
	}
	

	d_error_v = error_v - last_error_v;
	vdelta = error_v + d_error_v;
	last_error_v = error_v;
	//direction()
	//cmac////////////////////////////////////////////////////////////////


	//adative laws == == == == == == == == == == == =

	for (i = 1; i <= value; i++) {
		vdelta_weight_a[i] = -0.1*vdelta*vreceptive[i];
		//delta_weight_p(i, :) = 0.1*delta*receptive[i];

		vdelta_mean[i] = -0.01*vdelta*(vweight_a[i])*vreceptive[i] * (2 * (videnticalmatrix[i] - vmean[i]) / pow(vvar[i], 2));
		vdelta_var[i] = -0.01*vdelta*(vweight_a[i])*vreceptive[i] * (2 * pow((videnticalmatrix[i] - vmean[i]) ,2) / pow(vvar[i], 3));

		vdelta_mean2[i] = -0.01*vdelta*(weight_a[i])*vreceptive[i] * (2 * (videnticalmatrix2[i] - vmean2[i]) / pow(vvar2[i], 2));
		vdelta_var2[i] = -0.01*vdelta*(weight_a[i])*vreceptive[i] * (2 * pow((videnticalmatrix2[i] - vmean2[i]), 2) / pow(vvar2[i], 3));
		//update weight mean variance == == == == == == == == == ==


		vweight_a[i] = vweight_a[i] + vdelta_weight_a[i];
		//weight_p[i] = weight_p[i] + delta_weight_p[i];

		vmean[i] = vmean[i] + vdelta_mean[i];
		vvar[i] = vvar[i] + vdelta_var[i];

		vmean2[i] = vmean2[i] + vdelta_mean2[i];
		vvar2[i] = vvar2[i] + vdelta_var2[i];
	}

	//= == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == == ==
	//controller


	double videnticalmatrix[10] = { 1,1,1,1,1,1,1,1,1,1 };
	double videnticalmatrix2[10] = { 1,1,1,1,1,1,1,1,1,1 };

	for (i = 1; i <= value; i++) {
		videnticalmatrix[i] = videnticalmatrix[i] * error_v;
		videnticalmatrix2[i] = videnticalmatrix2[i] * d_error_v;
	}

	//%receptive layer == == == == == =
	for (i = 1; i <= value; i++) {
		vs[i] = exp(-pow(error_v - vmean[i], 2) / pow(vvar[i], 2));
		vs2[i] = exp(-pow(d_error_v - vmean2[i], 2) / pow(vvar2[i], 2));
		vreceptive[i] = vs[i] * vs2[i];
		vuc = vuc + vreceptive[i] * vweight_a[i];
	}

	//////////////////////////////////////////////////////////////////////


	tu_v = tu_v-0*vuc;

}






int main()
{
  init_motors();
  delay(200);

  fd = wiringPiI2CSetup (0x68);
  wiringPiI2CWriteReg8 (fd,0x6B,0x00);//disable sleep mode 
//  printf("set 0x6B=%X\n",wiringPiI2CReadReg8 (fd,0x6B));

  timer = getTimestamp();

  deltaT = (double) (getTimestamp() - timer)/1000000.0;
  read_all();

  last_x = get_x_rotation(accl_scaled_x, accl_scaled_y, accl_scaled_z);
  last_y = get_y_rotation(accl_scaled_x, accl_scaled_y, accl_scaled_z);


  gyro_offset_x = gyro_scaled_x;
  gyro_offset_y = gyro_scaled_y;

  gyro_total_x = last_x - gyro_offset_x;
  gyro_total_y = last_y - gyro_offset_y;


  while(T<=10) {
	  T = T + deltaT;
    t = getTimestamp();
    deltaT = (double) (t - timer)/1000000.0;
    timer = t;

    read_all();

    gyro_scaled_x -= gyro_offset_x;
    gyro_scaled_y -= gyro_offset_y;

    gyro_x_delta = (gyro_scaled_x * deltaT);
    gyro_y_delta = (gyro_scaled_y * deltaT);

    gyro_total_x += gyro_x_delta;
    gyro_total_y += gyro_y_delta;

    rotation_x = get_x_rotation(accl_scaled_x, accl_scaled_y, accl_scaled_z);
    rotation_y = get_y_rotation(accl_scaled_x, accl_scaled_y, accl_scaled_z);

//    printf("[BEFORE] gyro_scaled_y=%f, deltaT=%lf, rotation_y=%f, last_y= %f\n", (double)gyro_scaled_y, (double)deltaT, (double)rotation_y, (double) last_y);

//    printf("[1st part] = %f\n", (double) K0*(last_y + gyro_y_delta));
//    printf("[2nd part] = %f\n", (double) K1*rotation_y);
    last_x = K0 * (last_x + gyro_x_delta) + (K1 * rotation_x);
    last_y = K0 * (last_y + gyro_y_delta) + (K1 * rotation_y);

//    printf("[AFTER] gyro_scaled_y=%f, deltaT=%lf, rotation_y=%f, last_y=%f\n", (double)gyro_scaled_y, (double)deltaT, (double)rotation_y, (double) last_y);
    
    if (last_y < -60.0 || last_y > 60.0) 
      stop_motors();


	posture_controller();
    pidw();
	pidv();



	speed_r = (tu_v + tu_w) / 2;
	speed_l = (tu_v - tu_w) / 2;

	if (speed_r > 100) {
		speed_r = 100;
	}
	if (speed_r < -100) {
		speed_r = -100;
	}
	if (speed_l > 100) {
		speed_l = 100;
	}
	if (speed_l < -100) {
		speed_l = -100;
	}

	//printf("\n%lf\tLeft:%lf\tRight:%lf\t\n", error_theta, speed_r, speed_l);
	//printf("%1f\t%1f\t%1f\n", d_error, sliding, tu_v);
	printf("T:%lf\tdeltaT:%lf\ttimer:%lf\n",T,deltaT,timer);
	printf("vd:%lf\n", vd);
	printf("v:%lf\n", v);
	printf("tu_w:%lf\n",tu_w);
	printf("offset:%lf\n", angle_offset);
	printf("R:%lf\tL:%lf\n\n", speed_r,speed_l);
    motors(speed_r,speed_l, 0.0, 0.0);
    
	//===========================================================

	delta = delta + deltaT*w;
	delta = fmod(delta, (2 * pi));

	v = -5.2726*0.2323*(speed_r + speed_l)*0.5;
	w = gyro_scaled_z*pi / 180;
	d_w = (w - p_w) / deltaT;
	p_w = w;
	xv = v*deltaT;

	//tracking error dynamics
	d_x = cos(delta)*v;
	d_y = sin(delta)*v;
	d_delta = w;

	x = x + d_x*deltaT;
	y = y + d_y*deltaT;
	//============================================================
    delay(10);


  }

  stop_motors();
  return 0;
}
